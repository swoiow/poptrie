# Poptrie BIN Layout and Build Flow

This document describes how the binary is generated from TXT inputs.

## Input and Encoding

- Each file in the TXT directory is named by country code, e.g. `CN.txt`.
- The country code is encoded as a u16:
  - `code = (ord('C') << 8) | ord('N')`
- Each CIDR line is parsed and inserted into the trie with its country code value.

## Trie Construction

- The trie is built by bytes (IPv4/IPv6 both use byte paths).
- Insert CIDR:
  - Walk the path for the mask length.
  - Mark the target as a leaf with the country value.
  - If a larger prefix already marks a leaf, the smaller CIDR is ignored.

## Pruning

- If a node has all 256 children, and every child is a leaf with the same value,
  the node becomes a leaf and the subtree is removed.

## Node Serialization (BFS)

Each node is 72 bytes:

```
[ Child_BM 32 ][ Leaf_BM 32 ][ Child_Offset u32 ][ Leaf_Base_Index u32 ]
```

- `Child_BM`: branches that have subtrees.
- `Leaf_BM`: branches that are leaves.
- `Child_Offset`: byte offset to the first child node in the file.
- `Leaf_Base_Index`: index in the Value array for the first leaf under this node.

During BFS, for each node:

- Leaves are collected in key order, and their values are appended to the Value array.
- `Leaf_Base_Index = len(ValueArray)` before appending the node's leaves.

## Value Array

- After all nodes, a contiguous u16 array is appended.
- It contains leaf values in the exact order generated by BFS.

## Lookup Logic

- If `leaf_bitmap` bit `k` is set:
  - `m = popcount(leaf_bitmap[0..k))`
  - `index = base_index + m`
  - `value = values[index]` (u16 country code)
